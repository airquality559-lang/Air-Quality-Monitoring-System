<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Monitoring System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        /* Your existing CSS styles remain unchanged */
        /* ... */
    </style>
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="login-page">
        <!-- Your existing login page HTML remains unchanged -->
        <!-- ... -->
    </div>

    <!-- Admin Dashboard -->
    <div class="dashboard" id="admin-dashboard">
        <!-- Your existing admin dashboard HTML remains unchanged -->
        <!-- ... -->
    </div>

    <!-- Barangay Dashboard -->
    <div class="dashboard" id="barangay-dashboard" style="display: none;">
        <!-- Your existing barangay dashboard HTML remains unchanged -->
        <!-- ... -->
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="add-user-modal">
        <!-- Your existing modal HTML remains unchanged -->
        <!-- ... -->
    </div>

    <!-- Barangay Details Modal -->
    <div class="modal" id="barangay-modal">
        <!-- Your existing modal HTML remains unchanged -->
        <!-- ... -->
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-q_sjDr815xyKHnw4qupJoFeCa89rsTg",
            authDomain: "air-quality-monitoring-s-d6123.firebaseapp.com",
            databaseURL: "https://air-quality-monitoring-s-d6123-default-rtdb.firebaseio.com",
            projectId: "air-quality-monitoring-s-d6123",
            storageBucket: "air-quality-monitoring-s-d6123.firebasestorage.app",
            messagingSenderId: "410958753987",
            appId: "1:410958753987:web:546a09493fae6d8623f276",
            measurementId: "G-MQZTPTJXWP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let currentUserRole = '';
        let currentBarangayName = '';
        let currentPage = 1;
        const itemsPerPage = 10;
        let listenersInitialized = false;
        let barangayDataRef = null; // Reference for real-time barangay data

        // Default Admin Account
        const DEFAULT_ADMIN = {
            email: "admin@airquality.com",
            password: "Admin123!",
            name: "System Administrator"
        };

        // Chart instances tracking
        let chartInstances = {
            admin: {
                centralAqi: null,
                casidmanAqi: null
            },
            barangay: {
                aqi: null,
                dust: null
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize default admin account
            initializeDefaultAdmin();
            
            // Check if user is already logged in
            checkLoginStatus();

            // Initialize particles
            createParticles();

            // Login form submission
            document.getElementById('login-form').addEventListener('submit', handleLogin);

            // Modal functionality
            setupModals();

            // Dashboard functionality
            setupDashboard();

            // Dark mode toggle
            setupDarkMode();

            // Navigation functionality
            setupNavigation();

            // Print functionality
            setupPrintButtons();
        });

        // Initialize default admin account
        function initializeDefaultAdmin() {
            console.log("Initializing default admin account...");
            
            // Check if default admin already exists in approved users
            const approvedRef = database.ref('approvedUsers');
            approvedRef.once('value').then((snapshot) => {
                const approvedUsers = snapshot.val() || {};
                let adminExists = false;
                
                // Check if any admin user exists
                Object.values(approvedUsers).forEach(user => {
                    if (user.role === 'admin' && user.status === 'approved') {
                        adminExists = true;
                    }
                });
                
                if (!adminExists) {
                    console.log("No admin found, creating default admin...");
                    createDefaultAdminAccount();
                } else {
                    console.log("Admin account already exists");
                    // Auto-fill credentials even if admin exists
                    setTimeout(() => {
                        autoFillDefaultAdmin();
                    }, 1000);
                }
            }).catch((error) => {
                console.error("Error checking admin account:", error);
            });
        }

        // Create default admin account
        function createDefaultAdminAccount() {
            // First create the user in Firebase Auth
            auth.createUserWithEmailAndPassword(DEFAULT_ADMIN.email, DEFAULT_ADMIN.password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("Default admin created in Auth:", user.uid);
                    
                    // Add to approved users in database
                    const approvedRef = database.ref('approvedUsers/' + user.uid);
                    return approvedRef.set({
                        name: DEFAULT_ADMIN.name,
                        email: DEFAULT_ADMIN.email,
                        role: 'admin',
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        userId: user.uid,
                        isDefaultAdmin: true
                    });
                })
                .then(() => {
                    console.log("Default admin account created successfully!");
                    
                    // Auto-fill login form with default credentials for convenience
                    autoFillDefaultAdmin();
                })
                .catch((error) => {
                    console.error("Error creating default admin:", error);
                    
                    // If user already exists in Auth but not in database, add to database
                    if (error.code === 'auth/email-already-in-use') {
                        addExistingAdminToDatabase();
                    }
                });
        }

        // Add existing admin user to database
        function addExistingAdminToDatabase() {
            const approvedRef = database.ref('approvedUsers');
            approvedRef.once('value').then((snapshot) => {
                const approvedUsers = snapshot.val() || {};
                let adminExists = false;
                
                Object.values(approvedUsers).forEach(user => {
                    if (user.email === DEFAULT_ADMIN.email && user.role === 'admin') {
                        adminExists = true;
                    }
                });
                
                if (!adminExists) {
                    // Find the user UID by trying to sign in
                    auth.signInWithEmailAndPassword(DEFAULT_ADMIN.email, DEFAULT_ADMIN.password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            const approvedRef = database.ref('approvedUsers/' + user.uid);
                            return approvedRef.set({
                                name: DEFAULT_ADMIN.name,
                                email: DEFAULT_ADMIN.email,
                                role: 'admin',
                                status: 'approved',
                                approvedAt: new Date().toISOString(),
                                userId: user.uid,
                                isDefaultAdmin: true
                            });
                        })
                        .then(() => {
                            console.log("Existing admin added to database successfully!");
                            autoFillDefaultAdmin();
                            // Sign out after adding to database
                            auth.signOut();
                        })
                        .catch((error) => {
                            console.error("Error adding existing admin to database:", error);
                        });
                }
            });
        }

        // Auto-fill login form with default admin credentials
        function autoFillDefaultAdmin() {
            document.getElementById('email').value = DEFAULT_ADMIN.email;
            document.getElementById('password').value = DEFAULT_ADMIN.password;
            document.getElementById('role').value = 'admin';
            
            // Show helpful message
            const message = document.getElementById('error-message');
            message.textContent = 'Default admin credentials loaded. Click Login to continue.';
            message.className = 'message success';
            message.style.display = 'block';
        }

        // Check login status and redirect if already logged in
        function checkLoginStatus() {
            const userRole = localStorage.getItem('userRole');
            const userEmail = localStorage.getItem('userEmail');
            const barangayName = localStorage.getItem('barangayName');
            
            if (userEmail && userRole) {
                console.log('User is already logged in as:', userRole);
                // User is logged in, redirect to appropriate dashboard
                if (userRole === 'admin') {
                    showAdminDashboard();
                } else {
                    showBarangayDashboard(barangayName || userRole);
                }
            } else {
                // Auto-fill default admin credentials if no user is logged in
                setTimeout(() => {
                    autoFillDefaultAdmin();
                }, 1000);
            }
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const roleValue = document.getElementById('role').value;

            if (!email || !password || !roleValue) {
                showError('Please fill in all fields.');
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                return;
            }

            // Special handling for default admin
            if (email === DEFAULT_ADMIN.email && password === DEFAULT_ADMIN.password && roleValue === 'admin') {
                console.log("Default admin login attempt");
                handleDefaultAdminLogin(email, password);
                return;
            }

            // Determine role and email based on selection
            let role, loginEmail, barangayName;
            
            if (roleValue === 'admin') {
                // Admin role
                role = 'admin';
                loginEmail = email;
            } else {
                // Barangay roles (casidman, central)
                role = 'barangay';
                loginEmail = email;
                barangayName = roleValue.charAt(0).toUpperCase() + roleValue.slice(1);
            }

            checkUserApproval(loginEmail, password, role, barangayName);
        }

        // Handle default admin login
        function handleDefaultAdminLogin(email, password) {
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Check if admin exists in approved users
                    const approvedRef = database.ref('approvedUsers');
                    return approvedRef.once('value').then((snapshot) => {
                        const approvedUsers = snapshot.val() || {};
                        let adminApproved = false;
                        
                        Object.values(approvedUsers).forEach(user => {
                            if (user.email === email && user.role === 'admin' && user.status === 'approved') {
                                adminApproved = true;
                            }
                        });
                        
                        if (!adminApproved) {
                            // Auto-approve default admin
                            const user = userCredential.user;
                            const approvedRef = database.ref('approvedUsers/' + user.uid);
                            return approvedRef.set({
                                name: DEFAULT_ADMIN.name,
                                email: email,
                                role: 'admin',
                                status: 'approved',
                                approvedAt: new Date().toISOString(),
                                userId: user.uid,
                                isDefaultAdmin: true
                            });
                        }
                        return Promise.resolve();
                    });
                })
                .then(() => {
                    localStorage.setItem('userRole', 'admin');
                    localStorage.setItem('userEmail', email);
                    
                    showSuccess();
                    
                    setTimeout(() => {
                        showAdminDashboard();
                    }, 2000);
                })
                .catch((error) => {
                    let errorMsg = 'Invalid email or password.';
                    if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Invalid email address format.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMsg = 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMsg = 'Incorrect password.';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMsg = 'This account has been disabled.';
                    }
                    showError(errorMsg);
                    resetLoginButton();
                });
        }

        // Check user approval
        function checkUserApproval(email, password, role, barangayName = '') {
            console.log("Checking approval for:", email, "Role:", role);
            
            if (role === 'admin') {
                // For admin, check if it's an approved admin user
                checkAdminApproval(email, password);
                return;
            }
            
            // For barangay roles, check user approval
            checkBarangayUserApproval(email, password, role, barangayName);
        }

        // Check admin approval with default admin support
        function checkAdminApproval(email, password) {
            console.log("Checking admin approval for:", email);
            
            const approvedUsersRef = database.ref('approvedUsers');
            approvedUsersRef.once('value').then((snapshot) => {
                const approvedUsers = snapshot.val() || {};
                let isApprovedAdmin = false;
                
                Object.values(approvedUsers).forEach(user => {
                    if (user.email === email && user.role === 'admin' && user.status === 'approved') {
                        isApprovedAdmin = true;
                    }
                });
                
                if (isApprovedAdmin) {
                    performLogin(email, password, 'admin');
                } else {
                    // For default admin, auto-approve
                    if (email === DEFAULT_ADMIN.email) {
                        console.log("Auto-approving default admin");
                        handleDefaultAdminLogin(email, password);
                    } else {
                        showError('Admin account not approved or not found. Please contact system administrator.');
                        resetLoginButton();
                    }
                }
            }).catch((error) => {
                console.error("Error checking admin approval:", error);
                showError('Error checking admin status. Please try again.');
                resetLoginButton();
            });
        }

        // Check barangay user approval
        function checkBarangayUserApproval(email, password, role, barangayName) {
            const approvedUsersRef = database.ref('approvedUsers');
            const pendingUsersRef = database.ref('pendingUsers');
            
            Promise.all([
                approvedUsersRef.once('value'),
                pendingUsersRef.once('value')
            ]).then(([approvedSnapshot, pendingSnapshot]) => {
                const approvedUsers = approvedSnapshot.val() || {};
                const pendingUsers = pendingSnapshot.val() || {};
                
                // Check if user is approved
                let isApproved = false;
                Object.values(approvedUsers).forEach(user => {
                    if (user.email === email && user.status === 'approved') {
                        isApproved = true;
                    }
                });
                
                if (isApproved) {
                    performLogin(email, password, role, barangayName);
                } else {
                    // Check if user is pending
                    let isPending = false;
                    Object.values(pendingUsers).forEach(user => {
                        if (user.email === email) {
                            isPending = true;
                        }
                    });
                    
                    if (isPending) {
                        showError('Your account is pending admin approval. Please wait for approval email.');
                    } else {
                        showError('Account not found. Please register first.');
                    }
                    resetLoginButton();
                }
            }).catch((error) => {
                console.error("Error checking user approval:", error);
                showError('Error checking account status. Please try again.');
                resetLoginButton();
            });
        }

        // Perform login
        function performLogin(email, password, role, barangayName = '') {
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    localStorage.setItem('userRole', role);
                    localStorage.setItem('userEmail', email);
                    if (barangayName) {
                        localStorage.setItem('barangayName', barangayName);
                    }
                    
                    showSuccess();
                    
                    setTimeout(() => {
                        if (role === 'admin') {
                            showAdminDashboard();
                        } else {
                            // For barangay roles
                            showBarangayDashboard(barangayName);
                        }
                    }, 2000);
                })
                .catch((error) => {
                    let errorMsg = 'Invalid email or password.';
                    if (error.code === 'auth/invalid-email') {
                        errorMsg = 'Invalid email address format.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMsg = 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMsg = 'Incorrect password.';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMsg = 'This account has been disabled.';
                    }
                    showError(errorMsg);
                    resetLoginButton();
                });
        }

        // Show barangay dashboard
        function showBarangayDashboard(barangayName) {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('barangay-dashboard').style.display = 'flex';
            
            // Store current barangay name
            currentBarangayName = barangayName;
            
            // Update dashboard title and user info
            document.getElementById('barangay-dashboard-title').textContent = `Barangay Overview - ${barangayName}`;
            document.getElementById('barangay-user-name').textContent = barangayName;
            
            // Initialize barangay charts after a short delay
            setTimeout(() => {
                initializeBarangayCharts();
            }, 500);
            
            // Update real-time data for the specific barangay
            updateBarangayRealTimeData(barangayName);
            
            // Setup approval monitoring for active session
            setupApprovalMonitoring();
        }

        // Update barangay real-time data - ENHANCED with Firebase integration
        function updateBarangayRealTimeData(barangayName) {
            // Reference to the specific barangay data in Firebase
            const barangayRef = database.ref(`barangayData/${barangayName.toLowerCase()}`);
            
            // Store the reference for cleanup
            barangayDataRef = barangayRef;
            
            // Listen for real-time updates
            barangayRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    console.log(`Received data for ${barangayName}:`, data);
                    
                    // Update AQI value
                    document.getElementById('progressValue').textContent = data.aqi || 0;
                    
                    // Update dust level
                    document.getElementById('dustLevelValue').textContent = 
                        data.dust ? data.dust.toFixed(5) : '0.000';
                    
                    // Update AQI status
                    updateAQIStatus(data.aqi || 0);
                    
                    // Update circular progress bar
                    updateCircularProgress(data.aqi || 0);
                    
                    // Update AQI scale marker
                    updateAQIScaleMarker(data.aqi || 0);
                    
                    // Update min/max AQI
                    updateMinMaxAQI(data.aqi || 0);
                    
                    // Update charts with new data
                    updateBarangayCharts(data);
                    
                    // Save data to history
                    saveToHistory(barangayName, data);
                } else {
                    console.log(`No data found for ${barangayName}`);
                    // Set default values if no data
                    document.getElementById('progressValue').textContent = 0;
                    document.getElementById('dustLevelValue').textContent = '0.000';
                    updateAQIStatus(0);
                    updateCircularProgress(0);
                    updateAQIScaleMarker(0);
                }
            });
            
            // Also fetch historical data for charts
            fetchBarangayHistoricalData(barangayName);
        }

        // Save data to history
        function saveToHistory(barangayName, data) {
            const historyRef = database.ref(`barangayHistory/${barangayName.toLowerCase()}`);
            const timestamp = new Date().toISOString();
            
            historyRef.push({
                timestamp: timestamp,
                aqi: data.aqi || 0,
                dust: data.dust || 0,
                status: getAQIStatus(data.aqi || 0)
            });
        }

        // Get AQI status text
        function getAQIStatus(aqi) {
            if (aqi <= 50) return 'Good';
            if (aqi <= 100) return 'Moderate';
            return 'Polluted';
        }

        // Update min/max AQI values
        function updateMinMaxAQI(currentAQI) {
            // Get current min/max values
            let minAQI = parseInt(document.getElementById('minAQI').textContent) || currentAQI;
            let maxAQI = parseInt(document.getElementById('maxAQI').textContent) || currentAQI;
            
            // Update if needed
            if (currentAQI < minAQI) minAQI = currentAQI;
            if (currentAQI > maxAQI) maxAQI = currentAQI;
            
            // Update display
            document.getElementById('minAQI').textContent = minAQI;
            document.getElementById('maxAQI').textContent = maxAQI;
        }

        // Fetch historical data for charts
        function fetchBarangayHistoricalData(barangayName) {
            const historyRef = database.ref(`barangayHistory/${barangayName.toLowerCase()}`);
            
            historyRef.limitToLast(24).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateBarangayChartsWithHistory(data);
                }
            });
        }

        // Update barangay charts with historical data
        function updateBarangayChartsWithHistory(historyData) {
            // Process historical data and update charts
            const timestamps = [];
            const aqiValues = [];
            const dustValues = [];
            
            Object.values(historyData).forEach(entry => {
                const date = new Date(entry.timestamp);
                timestamps.push(date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
                aqiValues.push(entry.aqi);
                dustValues.push(entry.dust);
            });
            
            // Update AQI chart
            if (chartInstances.barangay.aqi) {
                chartInstances.barangay.aqi.data.labels = timestamps;
                chartInstances.barangay.aqi.data.datasets[0].data = aqiValues;
                chartInstances.barangay.aqi.update();
            }
            
            // Update dust chart
            if (chartInstances.barangay.dust) {
                chartInstances.barangay.dust.data.labels = timestamps;
                chartInstances.barangay.dust.data.datasets[0].data = dustValues;
                chartInstances.barangay.dust.update();
            }
        }

        // Update barangay charts with new data point
        function updateBarangayCharts(data) {
            // Add new data point to existing charts
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Update AQI chart
            if (chartInstances.barangay.aqi) {
                chartInstances.barangay.aqi.data.labels.push(currentTime);
                chartInstances.barangay.aqi.data.datasets[0].data.push(data.aqi || 0);
                
                // Keep only the last 12 data points
                if (chartInstances.barangay.aqi.data.labels.length > 12) {
                    chartInstances.barangay.aqi.data.labels.shift();
                    chartInstances.barangay.aqi.data.datasets[0].data.shift();
                }
                
                chartInstances.barangay.aqi.update('active');
            }
            
            // Update dust chart
            if (chartInstances.barangay.dust) {
                chartInstances.barangay.dust.data.labels.push(currentTime);
                chartInstances.barangay.dust.data.datasets[0].data.push(data.dust || 0);
                
                // Keep only the last 12 data points
                if (chartInstances.barangay.dust.data.labels.length > 12) {
                    chartInstances.barangay.dust.data.labels.shift();
                    chartInstances.barangay.dust.data.datasets[0].data.shift();
                }
                
                chartInstances.barangay.dust.update('active');
            }
        }

        // Update AQI status
        function updateAQIStatus(aqi) {
            const aqiStatus = document.getElementById('aqiStatus');
            
            let status = 'Good';
            let statusClass = 'status-good';
            let icon = 'fas fa-smile';
            
            if (aqi > 50 && aqi <= 100) {
                status = 'Moderate';
                statusClass = 'status-moderate';
                icon = 'fas fa-meh';
            } else if (aqi > 100) {
                status = 'Polluted';
                statusClass = 'status-polluted';
                icon = 'fas fa-frown';
            }
            
            aqiStatus.innerHTML = `<i class="${icon}"></i><span>${status}</span>`;
            aqiStatus.className = `aqi-status ${statusClass}`;
            
            // Update recommendations based on AQI status
            updateRecommendations(aqi);
        }

        // Update health recommendations based on AQI
        function updateRecommendations(aqi) {
            const recommendationsList = document.getElementById('recommendationsList');
            
            let recommendations = [];
            
            if (aqi <= 50) {
                recommendations = [
                    {
                        title: 'Air quality is good',
                        description: 'No health implications. Enjoy outdoor activities.'
                    },
                    {
                        title: 'Ventilation',
                        description: 'Keep windows open to allow fresh air circulation.'
                    },
                    {
                        title: 'Outdoor exercise',
                        description: 'Ideal conditions for outdoor physical activities.'
                    }
                ];
            } else if (aqi <= 100) {
                recommendations = [
                    {
                        title: 'Air quality is moderate',
                        description: 'Unusually sensitive individuals should consider reducing prolonged outdoor exertion.'
                    },
                    {
                        title: 'Ventilation',
                        description: 'Moderate ventilation is recommended.'
                    },
                    {
                        title: 'Sensitive groups',
                        description: 'People with respiratory conditions should take precautions.'
                    }
                ];
            } else {
                recommendations = [
                    {
                        title: 'Air quality is polluted',
                        description: 'Everyone may begin to experience health effects. Limit outdoor activities.'
                    },
                    {
                        title: 'Stay indoors',
                        description: 'Keep windows and doors closed to prevent polluted air from entering.'
                    },
                    {
                        title: 'Use air purifier',
                        description: 'Consider using an air purifier to improve indoor air quality.'
                    },
                    {
                        title: 'Wear mask',
                        description: 'If going outside is necessary, wear a protective mask.'
                    }
                ];
            }
            
            let recommendationsHTML = '';
            recommendations.forEach(rec => {
                recommendationsHTML += `
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <strong>${rec.title}</strong>
                            <p>${rec.description}</p>
                        </div>
                    </li>
                `;
            });
            
            recommendationsList.innerHTML = recommendationsHTML;
        }

        // Update circular progress
        function updateCircularProgress(aqi) {
            const progressCircle = document.getElementById('progressCircle');
            const maxAQI = 300; // Maximum AQI value for visualization
            
            // Calculate percentage (capped at 100%)
            const percentage = Math.min(aqi / maxAQI * 100, 100);
            
            // Create conic gradient based on AQI value
            let gradient;
            if (aqi <= 50) {
                gradient = `conic-gradient(#2dce89 0%, #2dce89 ${percentage}%, rgba(255, 255, 255, 0.2) ${percentage}%)`;
            } else if (aqi <= 100) {
                gradient = `conic-gradient(#FF8C00 0%, #FF8C00 ${percentage}%, rgba(255, 255, 255, 0.2) ${percentage}%)`;
            } else {
                gradient = `conic-gradient(#f5365c 0%, #f5365c ${percentage}%, rgba(255, 255, 255, 0.2) ${percentage}%)`;
            }
            
            progressCircle.style.background = gradient;
        }

        // Update AQI scale marker
        function updateAQIScaleMarker(aqi) {
            const aqiMarker = document.getElementById('aqiMarker');
            const maxAQI = 300; // Maximum AQI value for visualization
            
            // Calculate position (capped at 100%)
            const position = Math.min(aqi / maxAQI * 100, 100);
            
            aqiMarker.style.left = `${position}%`;
        }

        // Setup modals
        function setupModals() {
            // Add User Modal
            document.getElementById('add-user-link').addEventListener('click', () => {
                document.getElementById('add-user-modal').classList.add('active');
            });

            document.getElementById('close-user').addEventListener('click', () => {
                document.getElementById('add-user-modal').classList.remove('active');
            });

            document.getElementById('add-user-button').addEventListener('click', registerUser);

            // Barangay Details Modal
            document.getElementById('close-barangay-modal').addEventListener('click', () => {
                document.getElementById('barangay-modal').classList.remove('active');
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('add-user-modal')) {
                    document.getElementById('add-user-modal').classList.remove('active');
                }
                if (e.target === document.getElementById('barangay-modal')) {
                    document.getElementById('barangay-modal').classList.remove('active');
                }
            });
        }

        // Register user function
        function registerUser() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value.trim();
            const confirmPassword = document.getElementById('user-confirm-password').value.trim();
            const button = document.getElementById('add-user-button');
            const message = document.getElementById('user-message');
            
            if (!name || !email || !password || !confirmPassword) {
                showMessage(message, 'Please fill in all required fields.', 'error');
                return;
            }
            
            if (!isValidEmail(email)) {
                showMessage(message, 'Please enter a valid email address.', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage(message, 'Password must be at least 6 characters long.', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage(message, 'Passwords do not match.', 'error');
                return;
            }
            
            // Disable button to prevent multiple submissions
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
            
            // Check if user already exists in pending or approved users
            const pendingRef = database.ref('pendingUsers');
            const approvedRef = database.ref('approvedUsers');
            
            Promise.all([
                pendingRef.once('value'),
                approvedRef.once('value')
            ]).then(([pendingSnapshot, approvedSnapshot]) => {
                const pendingUsers = pendingSnapshot.val() || {};
                const approvedUsers = approvedSnapshot.val() || {};
                
                // Check if email already exists
                const allUsers = { ...pendingUsers, ...approvedUsers };
                const emailExists = Object.values(allUsers).some(user => user.email === email);
                
                if (emailExists) {
                    showMessage(message, 'This email is already registered.', 'error');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-plus-circle"></i> Register User';
                    return;
                }
                
                // Create user in Firebase Auth
                return auth.createUserWithEmailAndPassword(email, password);
            })
            .then((userCredential) => {
                if (!userCredential) return; // User already exists, exit
                
                const user = userCredential.user;
                
                // Add user to pending users - set role as 'user' by default
                const userRef = database.ref('pendingUsers/' + user.uid);
                return userRef.set({
                    name: name,
                    email: email,
                    role: 'user', // Default role
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    userId: user.uid
                });
            })
            .then(() => {
                showMessage(message, `User "${name}" registered successfully! Awaiting admin approval.`, 'success');
                button.innerHTML = '<i class="fas fa-plus-circle"></i> Register User';
                
                // Clear the form
                document.getElementById('user-name').value = '';
                document.getElementById('user-email').value = '';
                document.getElementById('user-password').value = '';
                document.getElementById('user-confirm-password').value = '';
                
                // Send notification to admin
                sendAdminUserNotification(name, email, 'user');
                
                // Close modal after successful registration
                setTimeout(() => {
                    document.getElementById('add-user-modal').classList.remove('active');
                    button.disabled = false;
                }, 2000);
            })
            .catch((error) => {
                let errorMsg = 'Failed to register user. ';
                if (error.code === 'auth/email-already-in-use') {
                    errorMsg = 'This email is already registered.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMsg = 'Invalid email address format.';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'Password is too weak.';
                } else {
                    errorMsg += error.message;
                }
                
                showMessage(message, errorMsg, 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plus-circle"></i> Register User';
            });
        }

        // Send admin notification for new user
        function sendAdminUserNotification(userName, email, role) {
            const notificationsRef = database.ref('adminNotifications');
            const newNotification = {
                type: 'new_user',
                title: 'New User Registration',
                message: `${userName} (${email}) has registered for a ${role} account. Please review and approve.`,
                userName: userName,
                userEmail: email,
                userRole: role,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            notificationsRef.push(newNotification)
                .then(() => {
                    console.log('Admin notification sent successfully');
                })
                .catch((error) => {
                    console.error('Error sending admin notification:', error);
                });
        }

        // Load user data for admin
        function loadUserData() {
            const pendingContainer = document.getElementById('pending-users-table-container');
            const approvedContainer = document.getElementById('approved-users-table-container');
            
            pendingContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            approvedContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const pendingRef = database.ref('pendingUsers');
            const approvedRef = database.ref('approvedUsers');
            
            Promise.all([
                pendingRef.once('value'),
                approvedRef.once('value')
            ]).then(([pendingSnapshot, approvedSnapshot]) => {
                const pendingUsers = pendingSnapshot.val() || {};
                const approvedUsers = approvedSnapshot.val() || {};
                
                displayPendingUsersTable(pendingUsers);
                displayApprovedUsersTable(approvedUsers);
                
                // Update user accounts count
                document.getElementById('user-accounts').textContent = Object.keys(approvedUsers).length;
                
                // Update user approved count
                document.getElementById('user-approved').textContent = Object.keys(approvedUsers).length;
            }).catch(error => {
                console.error("Error loading user data:", error);
                pendingContainer.innerHTML = approvedContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Data</h3>
                        <p>Failed to load user data. Please try again.</p>
                    </div>
                `;
            });
        }

        // Display pending users table
        function displayPendingUsersTable(users) {
            const container = document.getElementById('pending-users-table-container');
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Pending Users</h3>
                        <p>There are no user registration requests pending approval.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Date Registered</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                tableHTML += `
                    <tr data-id="${userId}">
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown'}</td>
                        <td><span class="status status-pending">Pending</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-approve" data-id="${userId}">Approve</button>
                            <button class="btn btn-reject" data-id="${userId}">Reject</button>
                            <button class="btn btn-view" data-id="${userId}">View</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            
            // Add event listeners
            document.querySelectorAll('#pending-users-table-container .btn-approve').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    approveUser(userId);
                });
            });
            
            document.querySelectorAll('#pending-users-table-container .btn-reject').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    rejectUser(userId);
                });
            });
            
            document.querySelectorAll('#pending-users-table-container .btn-view').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    viewUserDetails(userId, 'pendingUsers');
                });
            });
        }

        // Display approved users table
        function displayApprovedUsersTable(users) {
            const container = document.getElementById('approved-users-table-container');
            
            if (Object.keys(users).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Approved Users</h3>
                        <p>There are no approved users in the system yet.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Date Approved</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(users).forEach(userId => {
                const user = users[userId];
                tableHTML += `
                    <tr data-id="${userId}">
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${user.approvedAt ? new Date(user.approvedAt).toLocaleDateString() : 'Unknown'}</td>
                        <td><span class="status status-approved">Active</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-view" data-id="${userId}">View Details</button>
                            <button class="btn btn-reject" data-id="${userId}">Deactivate</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            
            // Add event listeners
            document.querySelectorAll('#approved-users-table-container .btn-view').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    viewUserDetails(userId, 'approvedUsers');
                });
            });
            
            document.querySelectorAll('#approved-users-table-container .btn-reject').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    deactivateUser(userId);
                });
            });
        }

        // Approve user function
        function approveUser(userId) {
            if(confirm('Are you sure you want to approve this user?')) {
                const pendingRef = database.ref('pendingUsers/' + userId);
                
                pendingRef.once('value').then((snapshot) => {
                    const user = snapshot.val();
                    
                    if (user) {
                        // Move user to approved users
                        const approvedRef = database.ref('approvedUsers/' + userId);
                        return approvedRef.set({
                            ...user,
                            status: 'approved',
                            approvedAt: new Date().toISOString()
                        }).then(() => {
                            // Remove from pending users
                            return pendingRef.remove();
                        });
                    } else {
                        alert('User data not found.');
                    }
                })
                .then(() => {
                    alert('User approved successfully!');
                    loadUserData();
                })
                .catch((error) => {
                    console.error('Error approving user:', error);
                    alert('Error approving user. Please try again.');
                });
            }
        }

        // Reject user function
        function rejectUser(userId) {
            if(confirm('Are you sure you want to reject this user?')) {
                const pendingRef = database.ref('pendingUsers/' + userId);
                
                pendingRef.remove()
                    .then(() => {
                        alert('User rejected successfully!');
                        loadUserData();
                    })
                    .catch((error) => {
                        console.error('Error rejecting user:', error);
                        alert('Error rejecting user. Please try again.');
                    });
            }
        }

        // Deactivate user function
        function deactivateUser(userId) {
            if(confirm('Are you sure you want to deactivate this user?')) {
                const approvedRef = database.ref('approvedUsers/' + userId);
                
                approvedRef.remove()
                    .then(() => {
                        alert('User deactivated successfully!');
                        loadUserData();
                    })
                    .catch((error) => {
                        console.error('Error deactivating user:', error);
                        alert('Error deactivating user. Please try again.');
                    });
            }
        }

        // View user details
        function viewUserDetails(userId, location) {
            const ref = database.ref(location + '/' + userId);
            
            ref.once('value').then((snapshot) => {
                const user = snapshot.val();
                
                if (user) {
                    showUserModal(user, user.status || 'pending');
                } else {
                    alert('User data not found.');
                }
            });
        }

        // Show user modal
        function showUserModal(user, status) {
            const dateField = status === 'approved' ? 'approvedAt' : 'createdAt';
            const date = user[dateField] ? new Date(user[dateField]).toLocaleDateString() : 'Unknown date';
            
            document.getElementById('barangay-details').innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">User Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Name:</strong> ${user.name}</p>
                            <p><strong>Email:</strong> ${user.email}</p>
                            <p><strong>Role:</strong> ${user.role}</p>
                        </div>
                        <div>
                            <p><strong>Date ${status === 'approved' ? 'Approved' : 'Registered'}:</strong> ${date}</p>
                            <p><strong>Status:</strong> <span class="status status-${status}">${status === 'approved' ? 'Approved' : 'Pending'}</span></p>
                            <p><strong>User ID:</strong> ${user.userId}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('barangay-modal').classList.add('active');
        }

        // Setup approval monitoring for active sessions
        function setupApprovalMonitoring() {
            // Listen for changes to user approval status
            const approvedUsersRef = database.ref('approvedUsers');
            
            approvedUsersRef.on('value', function(snapshot) {
                const currentUserEmail = localStorage.getItem('userEmail');
                if (!currentUserEmail) return;
                
                const approvedUsers = snapshot.val() || {};
                let isStillApproved = false;
                
                Object.values(approvedUsers).forEach(user => {
                    if (user.email === currentUserEmail && user.status === 'approved') {
                        isStillApproved = true;
                    }
                });
                
                if (!isStillApproved) {
                    // User was deactivated, force logout
                    alert('Your account has been deactivated by an administrator.');
                    localStorage.clear();
                    showLoginPage();
                }
            });
        }

        // Function to fetch all barangays from Firebase (only Casidman and Central)
        function fetchAllBarangays() {
            const container = document.getElementById('all-barangays-table-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            // Use default barangays (Casidman and Central)
            const defaultBarangays = [
                {
                    id: 'casidman-default',
                    name: 'Casidman',
                    city: 'Arteche',
                    email: 'casidman@barangay.com',
                    status: 'approved',
                    date: new Date().toLocaleDateString(),
                    type: 'approved'
                },
                {
                    id: 'central-default',
                    name: 'Central',
                    city: 'Arteche',
                    email: 'central@barangay.com',
                    status: 'approved',
                    date: new Date().toLocaleDateString(),
                    type: 'approved'
                }
            ];
            
            // Update the total barangays count
            updateTotalBarangaysCount(defaultBarangays.length);
            
            // Display the barangays table
            displayAllBarangaysTable(defaultBarangays);
        }

        // Function to update the total barangays count
        function updateTotalBarangaysCount(count) {
            document.getElementById('total-barangays').textContent = count;
            document.getElementById('pending-barangays').textContent = count; // Active barangays count
        }

        // Function to display all barangays in a table (simplified - no approval actions)
        function displayAllBarangaysTable(barangays) {
            const container = document.getElementById('all-barangays-table-container');
            
            if (barangays.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No Barangays Found</h3>
                        <p>There are no barangays registered in the system.</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Barangay Name</th>
                            <th>Municipality</th>
                            <th>Admin Email</th>
                            <th>Status</th>
                            <th>Date Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            barangays.forEach(barangay => {
                tableHTML += `
                    <tr data-id="${barangay.id}">
                        <td>${barangay.name}</td>
                        <td>${barangay.city}</td>
                        <td>${barangay.email}</td>
                        <td><span class="status status-approved">Active</span></td>
                        <td>${barangay.date}</td>
                        <td class="action-buttons">
                            <button class="btn btn-view" data-id="${barangay.id}">View Details</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
            
            // Add event listeners for the view buttons only
            document.querySelectorAll('#all-barangays-table-container .btn-view').forEach(button => {
                button.addEventListener('click', function() {
                    const barangayId = this.getAttribute('data-id');
                    viewBarangayDetails(barangayId, 'approvedBarangays');
                });
            });
        }

        // Simplified viewBarangayDetails function
        function viewBarangayDetails(barangayId, location) {
            // For default barangays, show static details
            if (barangayId.includes('default')) {
                showBarangayModal({
                    name: barangayId.includes('casidman') ? 'Casidman' : 'Central',
                    city: 'Arteche',
                    gmail: barangayId.includes('casidman') ? 'casidman@barangay.com' : 'central@barangay.com',
                    status: 'approved',
                    approvedAt: new Date().toISOString()
                }, 'approved');
                return;
            }

            // For Firebase barangays, fetch details
            const ref = database.ref(location + '/' + barangayId);
            
            ref.once('value').then((snapshot) => {
                const barangay = snapshot.val();
                
                if (barangay) {
                    showBarangayModal(barangay, 'approved');
                } else {
                    alert('Barangay data not found.');
                }
            });
        }

        // Show barangay modal
        function showBarangayModal(barangay, status) {
            const dateField = status === 'approved' ? 'approvedAt' : 'createdAt';
            const date = barangay[dateField] ? new Date(barangay[dateField]).toLocaleDateString() : 'Unknown date';
            
            document.getElementById('barangay-details').innerHTML = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">Barangay Information</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Barangay Name:</strong> ${barangay.name || barangay.barangayName || 'Unknown'}</p>
                            <p><strong>Municipality:</strong> ${barangay.city || barangay.municipality || 'Unknown'}</p>
                            <p><strong>Admin Email:</strong> ${barangay.gmail || barangay.email || 'No email'}</p>
                        </div>
                        <div>
                            <p><strong>Date ${status === 'approved' ? 'Approved' : 'Registered'}:</strong> ${date}</p>
                            <p><strong>Status:</strong> <span class="status status-${status}">${status === 'approved' ? 'Approved' : 'Pending'}</span></p>
                            ${barangay.adminName ? `<p><strong>Admin Name:</strong> ${barangay.adminName}</p>` : ''}
                            ${barangay.adminPhone ? `<p><strong>Contact Number:</strong> ${barangay.adminPhone}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('barangay-modal').classList.add('active');
        }

        // Simplified function to load barangay data for overview stats only
        function loadBarangayData() {
            console.log("Loading barangay data for stats...");
            
            // Update stats - set to 2 for Casidman and Central
            document.getElementById('pending-barangays').textContent = 2;
            document.getElementById('total-barangays').textContent = 2;
            
            // Show barangay information table
            const defaultBarangays = [
                {
                    id: 'casidman-default',
                    name: 'Casidman',
                    city: 'Arteche',
                    email: 'casidman@barangay.com',
                    status: 'approved',
                    date: new Date().toLocaleDateString()
                },
                {
                    id: 'central-default',
                    name: 'Central',
                    city: 'Arteche',
                    email: 'central@barangay.com',
                    status: 'approved',
                    date: new Date().toLocaleDateString()
                }
            ];
            
            displayBarangayInfoTable(defaultBarangays);
        }

        // Display barangay information table in overview
        function displayBarangayInfoTable(barangays) {
            const container = document.getElementById('approved-table-container');
            
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Barangay Name</th>
                            <th>Municipality</th>
                            <th>Admin Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            barangays.forEach(barangay => {
                tableHTML += `
                    <tr data-id="${barangay.id}">
                        <td>${barangay.name}</td>
                        <td>${barangay.city}</td>
                        <td>${barangay.email}</td>
                        <td><span class="status status-approved">Active</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-view" data-id="${barangay.id}">View Details</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
            
            // Add event listeners for the view buttons
            document.querySelectorAll('#approved-table-container .btn-view').forEach(button => {
                button.addEventListener('click', function() {
                    const barangayId = this.getAttribute('data-id');
                    viewBarangayDetails(barangayId, 'approvedBarangays');
                });
            });
        }

        // Setup navigation
        function setupNavigation() {
            // Admin navigation
            document.querySelectorAll('#admin-dashboard .menu-item').forEach(item => {
                if (item.getAttribute('data-section')) {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const section = this.getAttribute('data-section');
                        
                        // Update active menu item
                        document.querySelectorAll('#admin-dashboard .menu-item').forEach(i => {
                            i.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Update header title
                        const headerTitle = document.querySelector('#admin-dashboard .header-left h1');
                        headerTitle.textContent = getSectionTitle(section);
                        
                        // Hide all sections first
                        document.querySelectorAll('#admin-dashboard .content > div').forEach(div => {
                            div.classList.remove('active');
                            div.style.display = 'none';
                        });
                        
                        // Show the selected section
                        const targetSection = document.getElementById(`${section}-section`);
                        if (targetSection) {
                            targetSection.classList.add('active');
                            targetSection.style.display = 'block';
                            
                            // Initialize charts if showing overview
                            if (section === 'overview') {
                                setTimeout(() => {
                                    initializeAdminCharts();
                                    loadBarangayData(); // Load barangay data for overview
                                }, 100);
                            }
                        }
                        
                        // Load section-specific data
                        if (section === 'history') {
                            loadHistoryData();
                        } else if (section === 'barangays') {
                            fetchAllBarangays(); // Show only Casidman and Central
                        } else if (section === 'users') {
                            loadUserData();
                        }
                    });
                }
            });

            // Barangay navigation
            document.querySelectorAll('#barangay-dashboard .menu-item').forEach(item => {
                if (item.getAttribute('data-section')) {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const section = this.getAttribute('data-section');
                        
                        // Update active menu item
                        document.querySelectorAll('#barangay-dashboard .menu-item').forEach(i => {
                            i.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Update header title
                        const headerTitle = document.querySelector('#barangay-dashboard .header-left h1');
                        headerTitle.textContent = getBarangaySectionTitle(section);
                        
                        // Hide all sections first
                        document.querySelectorAll('#barangay-dashboard .content > div').forEach(div => {
                            div.classList.remove('active');
                            div.style.display = 'none';
                        });
                        
                        // Show the selected section
                        const targetSection = document.getElementById(`barangay-${section}-section`);
                        if (targetSection) {
                            targetSection.classList.add('active');
                            targetSection.style.display = 'block';
                            
                            // Initialize charts if showing overview
                            if (section === 'overview') {
                                setTimeout(() => {
                                    initializeBarangayCharts();
                                }, 100);
                            }
                        }
                        
                        // Load section-specific data
                        if (section === 'history') {
                            loadBarangayHistoryData();
                        }
                    });
                }
            });
        }

        function getSectionTitle(section) {
            const titles = {
                'overview': 'Overview',
                'barangays': 'Barangays',
                'users': 'Users',
                'history': 'History'
            };
            return titles[section] || 'Dashboard';
        }

        function getBarangaySectionTitle(section) {
            const titles = {
                'overview': 'Barangay Overview',
                'history': 'Barangay History'
            };
            return titles[section] || 'Barangay Dashboard';
        }

        function setupDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const barangayDarkModeToggle = document.getElementById('barangay-dark-mode-toggle');
            
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
            }
            
            darkModeToggle.addEventListener('click', toggleDarkMode);
            barangayDarkModeToggle.addEventListener('click', toggleDarkMode);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            
            // Save preference to localStorage
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('darkMode', 'enabled');
            } else {
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function setupDashboard() {
            // Only set up listeners once
            if (listenersInitialized) return;
            listenersInitialized = true;

            // Admin logout button
            document.getElementById('sidebar-logout-btn').addEventListener('click', () => {
                if(confirm('Are you sure you want to logout?')) {
                    // Clear success message before logging out
                    document.getElementById('success-message').style.display = 'none';
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('barangayName');
                    localStorage.removeItem('barangayId');
                    showLoginPage();
                }
            });

            // Barangay logout button
            document.getElementById('barangay-sidebar-logout-btn').addEventListener('click', () => {
                if(confirm('Are you sure you want to logout?')) {
                    // Clear success message before logging out
                    document.getElementById('success-message').style.display = 'none';
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('barangayName');
                    localStorage.removeItem('barangayId');
                    
                    // Remove Firebase listeners
                    if (barangayDataRef) {
                        barangayDataRef.off();
                    }
                    
                    showLoginPage();
                }
            });

            // Load barangay data initially
            loadBarangayData();

            // Search functionality
            document.getElementById('search-approved').addEventListener('input', function() {
                filterTable('approved-table-container', this.value);
            });

            // Date search functionality for history
            document.getElementById('search-history-date').addEventListener('input', function() {
                filterHistoryByDate(this.value);
            });

            document.getElementById('search-barangay-history-date').addEventListener('input', function() {
                filterBarangayHistoryByDate(this.value);
            });

            // Time period selector
            document.getElementById('time-period').addEventListener('change', function() {
                alert(`Loading data for: ${this.options[this.selectedIndex].text}`);
            });
        }

        // MODIFIED: Initialize admin charts with Central and Casidman AQI trends
        function initializeAdminCharts() {
            // Destroy existing charts if they exist
            if (chartInstances.admin.centralAqi) {
                chartInstances.admin.centralAqi.destroy();
            }
            if (chartInstances.admin.casidmanAqi) {
                chartInstances.admin.casidmanAqi.destroy();
            }

            // Central AQI Chart
            const centralAqiCtx = document.getElementById('centralAqiChart');
            if (centralAqiCtx) {
                chartInstances.admin.centralAqi = new Chart(centralAqiCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{
                            label: 'Central Air Quality Index',
                            data: [45, 52, 48, 55, 60, 58, 62],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Casidman AQI Chart
            const casidmanAqiCtx = document.getElementById('casidmanAqiChart');
            if (casidmanAqiCtx) {
                chartInstances.admin.casidmanAqi = new Chart(casidmanAqiCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [{
                            label: 'Casidman Air Quality Index',
                            data: [42, 48, 45, 50, 55, 52, 58],
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Fetch live data for both barangays
            fetchLiveBarangayData();
        }

        // Fetch live data for both Central and Casidman
        function fetchLiveBarangayData() {
            // Central data
            const centralRef = database.ref('barangayData/central');
            centralRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && chartInstances.admin.centralAqi) {
                    updateAdminChartWithLiveData(chartInstances.admin.centralAqi, data.aqi);
                }
            });
            
            // Casidman data
            const casidmanRef = database.ref('barangayData/casidman');
            casidmanRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && chartInstances.admin.casidmanAqi) {
                    updateAdminChartWithLiveData(chartInstances.admin.casidmanAqi, data.aqi);
                }
            });
        }

        // Update admin chart with live data
        function updateAdminChartWithLiveData(chart, newAqi) {
            // Add new data point to the chart
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Add new label and data point
            chart.data.labels.push(currentTime);
            chart.data.datasets[0].data.push(newAqi);
            
            // Keep only the last 12 data points
            if (chart.data.labels.length > 12) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            
            // Update the chart
            chart.update('active');
        }

        function initializeBarangayCharts() {
            // Destroy existing charts if they exist
            if (chartInstances.barangay.aqi) {
                chartInstances.barangay.aqi.destroy();
            }
            if (chartInstances.barangay.dust) {
                chartInstances.barangay.dust.destroy();
            }

            // Air Quality Chart
            const airCtx = document.getElementById('airChart');
            if (airCtx) {
                chartInstances.barangay.aqi = new Chart(airCtx, {
                    type: 'line',
                    data: {
                        labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                        datasets: [{
                            label: 'AQI',
                            data: [35, 42, 38, 45, 50, 48],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false
                                },
                                title: {
                                    display: true,
                                    text: 'AQI Value'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Dust Level Chart
            const dustCtx = document.getElementById('dustChart');
            if (dustCtx) {
                chartInstances.barangay.dust = new Chart(dustCtx, {
                    type: 'line',
                    data: {
                        labels: ['6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                        datasets: [{
                            label: 'Dust Level (mg/m³)',
                            data: [114.89, 115.23, 116.78, 113.45, 117.12, 118.56],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    drawBorder: false
                                },
                                title: {
                                    display: true,
                                    text: 'Dust Level (mg/m³)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        function showAdminDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'flex';
            
            // Initialize charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                initializeAdminCharts();
            }, 500);
            
            loadUserData();
            
            // Setup approval monitoring for active session
            setupApprovalMonitoring();
        }

        function filterTable(containerId, searchText) {
            const container = document.getElementById(containerId);
            const table = container.querySelector('table');
            
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            const searchLower = searchText.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchLower) ? '' : 'none';
            });
        }

        function showLoginPage() {
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('barangay-dashboard').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            // Clear login form
            document.getElementById('login-form').reset();
            resetLoginButton();
            // Clear success message when showing login page
            document.getElementById('success-message').style.display = 'none';
        }

        function resetLoginButton() {
            const loginButton = document.getElementById('login-button');
            loginButton.disabled = false;
            loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        }

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            errorMessage.className = 'message error';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('success-message').className = 'message success';
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.style.display = 'block';
            element.className = `message ${type}`;
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                const size = Math.random() * 15 + 5;
                const posX = Math.random() * 100;
                const posY = Math.random() * 100;
                const animationDelay = Math.random() * 15;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${posX}vw`;
                particle.style.top = `${posY}vh`;
                particle.style.animationDelay = `${animationDelay}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordField = document.getElementById('password');
            const type = passwordField.type === 'password' ? 'text' : 'password';
            passwordField.type = type;
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });

        // History Section Functions
        function loadHistoryData() {
            // Simulate loading history data
            const historyData = generateHistoryData();
            displayHistoryData(historyData);
            
            // Populate barangay filter
            populateBarangayFilter();
        }

        function loadBarangayHistoryData() {
            // Load barangay-specific history data from Firebase
            if (!currentBarangayName) return;
            
            const historyRef = database.ref(`barangayHistory/${currentBarangayName.toLowerCase()}`);
            
            historyRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                const historyData = [];
                
                if (data) {
                    Object.values(data).forEach(entry => {
                        historyData.push({
                            dateTime: new Date(entry.timestamp).toLocaleString(),
                            aqi: entry.aqi,
                            dust: entry.dust,
                            status: entry.status
                        });
                    });
                    
                    // Sort by date (newest first)
                    historyData.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                }
                
                displayBarangayHistoryData(historyData);
            });
        }

        function generateHistoryData() {
            // This would normally come from Firebase
            // For now, we'll simulate data based on approved barangays
            
            const data = [];
            
            // Use Casidman and Central for data generation
            const barangays = ['Casidman', 'Central'];
            
            for (let i = 0; i < 50; i++) {
                const date = new Date();
                date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                date.setHours(Math.floor(Math.random() * 24));
                date.setMinutes(Math.floor(Math.random() * 60));
                
                const barangay = barangays[Math.floor(Math.random() * barangays.length)];
                const aqi = Math.floor(Math.random() * 150);
                const dust = (Math.random() * 20 + 110).toFixed(5);
                
                // Determine status based on AQI value
                let status = 'Good';
                if (aqi > 50 && aqi <= 100) {
                    status = 'Moderate';
                } else if (aqi > 100) {
                    status = 'Polluted';
                }
                
                data.push({
                    dateTime: date.toLocaleString(),
                    barangay: barangay,
                    aqi: aqi,
                    dust: dust,
                    status: status
                });
            }
            
            // Sort by date (newest first)
            return data.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
        }

        function displayHistoryData(data) {
            const tableBody = document.getElementById('history-table-body');
            const pagination = document.getElementById('history-pagination');
            
            // Clear existing data
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);
            
            // Display data for current page
            for (let i = startIndex; i < endIndex; i++) {
                const item = data[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.dateTime}</td>
                    <td>${item.barangay}</td>
                    <td>${item.aqi}</td>
                    <td>${item.dust}</td>
                    <td><span class="status status-${item.status.toLowerCase()}">${item.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            }
            
            // Generate pagination
            generatePagination(pagination, currentPage, totalPages, 'history');
        }

        function displayBarangayHistoryData(data) {
            const tableBody = document.getElementById('barangay-history-table-body');
            const pagination = document.getElementById('barangay-history-pagination');
            
            // Clear existing data
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, data.length);
            
            // Display data for current page
            for (let i = startIndex; i < endIndex; i++) {
                const item = data[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.dateTime}</td>
                    <td>${item.aqi}</td>
                    <td>${item.dust}</td>
                    <td><span class="status status-${item.status.toLowerCase()}">${item.status}</span></td>
                `;
                
                tableBody.appendChild(row);
            }
            
            // Generate pagination
            generatePagination(pagination, currentPage, totalPages, 'barangay-history');
        }

        function generatePagination(container, currentPage, totalPages, type) {
            container.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-btn';
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    if (type === 'history') {
                        const data = generateHistoryData();
                        displayHistoryData(data);
                    } else {
                        loadBarangayHistoryData();
                    }
                }
            });
            container.appendChild(prevButton);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    if (type === 'history') {
                        const data = generateHistoryData();
                        displayHistoryData(data);
                    } else {
                        loadBarangayHistoryData();
                    }
                });
                container.appendChild(pageButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-btn';
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    if (type === 'history') {
                        const data = generateHistoryData();
                        displayHistoryData(data);
                    } else {
                        loadBarangayHistoryData();
                    }
                }
            });
            container.appendChild(nextButton);
        }

        function populateBarangayFilter() {
            const filter = document.getElementById('history-barangay-filter');
            filter.innerHTML = '<option value="all">All Barangays</option>';
            
            // Add Casidman and Central to filter
            const barangays = ['Casidman', 'Central'];
            
            barangays.forEach(barangay => {
                const option = document.createElement('option');
                option.value = barangay.toLowerCase().replace(/\s+/g, '-');
                option.textContent = barangay;
                filter.appendChild(option);
            });
            
            // Add event listener for filter change
            filter.addEventListener('change', function() {
                const selectedBarangay = this.value;
                if (selectedBarangay === 'all') {
                    // Show all history data
                    const data = generateHistoryData();
                    displayHistoryData(data);
                } else {
                    // Filter history data by selected barangay
                    filterHistoryByBarangay(selectedBarangay);
                }
            });
        }

        function filterHistoryByBarangay(barangayName) {
            // In a real implementation, this would query Firebase for specific barangay data
            const allData = generateHistoryData();
            const filteredData = allData.filter(item => {
                const itemBarangay = item.barangay.toLowerCase().replace(/\s+/g, '-');
                return itemBarangay === barangayName;
            });
            
            displayHistoryData(filteredData);
        }

        function filterHistoryByDate(searchText) {
            const tableBody = document.getElementById('history-table-body');
            const rows = tableBody.querySelectorAll('tr');
            const searchLower = searchText.toLowerCase();
            
            rows.forEach(row => {
                const dateCell = row.cells[0];
                const dateText = dateCell.textContent.toLowerCase();
                row.style.display = dateText.includes(searchLower) ? '' : 'none';
            });
        }

        function filterBarangayHistoryByDate(searchText) {
            const tableBody = document.getElementById('barangay-history-table-body');
            const rows = tableBody.querySelectorAll('tr');
            const searchLower = searchText.toLowerCase();
            
            rows.forEach(row => {
                const dateCell = row.cells[0];
                const dateText = dateCell.textContent.toLowerCase();
                row.style.display = dateText.includes(searchLower) ? '' : 'none';
            });
        }

        // Add search functionality for all barangays
        document.getElementById('search-all-barangays').addEventListener('input', function() {
            filterAllBarangaysTable(this.value);
        });

        function filterAllBarangaysTable(searchText) {
            const container = document.getElementById('all-barangays-table-container');
            const table = container.querySelector('table');
            
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            const searchLower = searchText.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchLower) ? '' : 'none';
            });
        }

        // Setup print buttons - MODIFIED to ensure no pagination in print
        function setupPrintButtons() {
            // Admin print button
            document.getElementById('print-history-btn').addEventListener('click', function() {
                // Before printing, ensure all table rows are visible
                const historyTableBody = document.getElementById('history-table-body');
                if (historyTableBody) {
                    const rows = historyTableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = 'table-row';
                    });
                }
                
                // Also ensure all barangay history rows are visible
                const barangayHistoryTableBody = document.getElementById('barangay-history-table-body');
                if (barangayHistoryTableBody) {
                    const rows = barangayHistoryTableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = 'table-row';
                    });
                }
                
                window.print();
            });

            // Barangay print button
            document.getElementById('print-barangay-history-btn').addEventListener('click', function() {
                // Before printing, ensure all table rows are visible
                const barangayHistoryTableBody = document.getElementById('barangay-history-table-body');
                if (barangayHistoryTableBody) {
                    const rows = barangayHistoryTableBody.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.style.display = 'table-row';
                    });
                }
                
                window.print();
            });
        }
    </script>
</body>
</html>
